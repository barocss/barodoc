---
import { getCollection } from "astro:content";
import DocsLayout from "../../layouts/DocsLayout.astro";
import config from "virtual:barodoc/config";
import { defaultLocale, locales } from "virtual:barodoc/i18n";
import { getLocalizedNavGroup } from "@barodoc/core";

export async function getStaticPaths() {
  const docs = await getCollection("docs");
  
  return docs.map((doc) => {
    // Handle locale in slug
    const slugParts = doc.slug.split("/");
    const hasLocale = locales.includes(slugParts[0]);
    
    let locale = defaultLocale;
    let cleanSlug = doc.slug;
    
    if (hasLocale) {
      locale = slugParts[0];
      cleanSlug = slugParts.slice(1).join("/");
    }
    
    // URL: /docs/introduction (en), /docs/ko/introduction (ko) â€” locale only inside slug
    const path = locale === defaultLocale 
      ? cleanSlug 
      : `${locale}/${cleanSlug}`;
    
    return {
      params: { slug: path || undefined },
      props: { doc, locale, cleanSlug },
    };
  });
}

interface Props {
  doc: Awaited<ReturnType<typeof getCollection<"docs">>>[number];
  locale: string;
  cleanSlug: string;
}

const { doc, locale, cleanSlug } = Astro.props;
const { Content, headings } = await doc.render();

// Find the category (navigation group) for this page
function findCategory(slug: string): string | null {
  for (const group of config.navigation) {
    if (group.pages.includes(slug)) {
      return getLocalizedNavGroup(group, locale, defaultLocale);
    }
  }
  return null;
}

// Get all pages in order from navigation
function getAllPages(): string[] {
  const pages: string[] = [];
  for (const group of config.navigation) {
    pages.push(...group.pages);
  }
  return pages;
}

// Get page title from slug
function getPageTitle(slug: string): string {
  const parts = slug.split('/');
  const name = parts[parts.length - 1];
  return name
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

// Get page href (always /docs/...; non-default locale is inside slug)
function getPageHref(slug: string): string {
  return `/docs/${locale === defaultLocale ? slug : `${locale}/${slug}`}`;
}

// Find prev/next pages
const allPages = getAllPages();
const currentIndex = allPages.indexOf(cleanSlug);

const prevPage = currentIndex > 0 
  ? { title: getPageTitle(allPages[currentIndex - 1]), href: getPageHref(allPages[currentIndex - 1]) }
  : null;

const nextPage = currentIndex < allPages.length - 1 
  ? { title: getPageTitle(allPages[currentIndex + 1]), href: getPageHref(allPages[currentIndex + 1]) }
  : null;

const category = findCategory(cleanSlug);
---

<DocsLayout 
  title={doc.data.title} 
  description={doc.data.description}
  headings={headings}
  prevPage={prevPage}
  nextPage={nextPage}
>
  {category && (
    <p class="text-xs font-medium uppercase tracking-wider text-primary-600 dark:text-primary-400 mb-2">
      {category}
    </p>
  )}
  <h1>{doc.data.title}</h1>
  {doc.data.description && (
    <p class="lead text-sm text-[var(--color-text-secondary)] mt-1 mb-4">
      {doc.data.description}
    </p>
  )}
  <Content />
</DocsLayout>
